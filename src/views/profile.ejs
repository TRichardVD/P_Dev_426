<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profil</title>
    <!-- <link rel="stylesheet" href="/css/style.css" /> -->
    <link rel="stylesheet" href="/css/profile.css" />
  </head>
  <body>
    <%- include("partials/header") %>

    <main>
      <!-- Section des informations utilisateur -->
      <section class="profile-info">
        <div class="profile-header">
          <img
            src="/images/profile-img.png"
            alt="Photo de profil"
            class="profile-picture"
          />
          <div class="profile-details">
            <p>
              <strong>Pr√©nom :</strong>
              <span id="username-display"><%= user.username %></span>
            </p>
            <p>
              <strong>Email :</strong>
              <span id="email-display"><%= user.email %></span>
            </p>
            <p><strong>Mot de passe :</strong> ********</p>
          </div>
          <button class="edit-button">‚úèÔ∏è Modifier</button>
          <button class="save-button" style="display: none">
            üíæ Sauvegarder
          </button>
          <button class="reset-password-button">
            üîí R√©initialiser le mot de passe
          </button>
        </div>

        <!-- Formulaire de r√©initialisation du mot de passe -->
        <div id="reset-password-form" style="display: none">
          <h3>R√©initialiser le mot de passe</h3>
          <form id="password-reset-form" method="POST">
            <label for="password">Nouveau mot de passe :</label>
            <input type="password" id="password" name="password" required />

            <label for="confirm-password">Confirmer le mot de passe :</label>
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              required
            />

            <button type="submit" class="btn">Enregistrer</button>
          </form>
        </div>
      </section>

      <!-- Section des sites pr√©f√©r√©s -->
      <section class="favorite-sites">
        <h2>Vos sites pr√©f√©r√©s</h2>
        <% if (user.likedSites.length > 0) { %>
        <div class="sites-grid">
          <% user.likedSites.forEach((site) => { %>
          <div class="site-card">
            <% if (site.images && site.images.length > 0) { %>
            <img src="<%= site.images[0] %>" alt="<%= site.name %>" />
            <% } else { %>
            <img
              src="/images/backgrounds/login-bg.jpg"
              alt="Image par d√©faut"
            />
            <% } %>
            <div class="site-info">
              <h3><%= site.name %></h3>
              <p><%= site.description %></p>
            </div>
            <button class="like-button">‚ù§Ô∏è</button>
          </div>
          <% }); %>
        </div>
        <% } else { %>
        <p>Aucun site pr√©f√©r√© enregistr√©.</p>
        <% } %>
      </section>

      <section class="favorite-sites">
        <h2>Vos listes de sites</h2>
        <% user.lists.forEach((list) => { %>
        <h3><%= list.name %></h3>

        <% }); %>
      </section>

      <%- include("partials/footer") %>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const editButton = document.querySelector(".edit-button");
        const saveButton = document.querySelector(".save-button");
        const resetPasswordButton = document.querySelector(
          ".reset-password-button"
        );
        const resetPasswordForm = document.getElementById(
          "reset-password-form"
        );
        const usernameDisplay = document.getElementById("username-display");
        const emailDisplay = document.getElementById("email-display");

        editButton.addEventListener("click", () => {
          // Transform username and email into input fields
          usernameDisplay.innerHTML = `<input type="text" id="username-input" value="${usernameDisplay.textContent}" />`;
          emailDisplay.innerHTML = `<input type="email" id="email-input" value="${emailDisplay.textContent}" />`;

          // Show the save button and hide the edit button
          editButton.style.display = "none";
          saveButton.style.display = "inline-block";
        });

        saveButton.addEventListener("click", async () => {
          const usernameInput = document.getElementById("username-input").value;
          const emailInput = document.getElementById("email-input").value;

          try {
            // Send the updated data via AJAX
            const response = await fetch("/api/user/edit-profile", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                username: usernameInput,
                email: emailInput,
              }),
            });

            if (!response.ok) {
              throw new Error("Erreur lors de la mise √† jour du profil.");
            }

            // Update the display with the new values
            usernameDisplay.textContent = usernameInput;
            emailDisplay.textContent = emailInput;

            // Hide the save button and show the edit button
            saveButton.style.display = "none";
            editButton.style.display = "inline-block";
          } catch (error) {
            console.error(error);
            alert("Une erreur est survenue lors de la mise √† jour.");
          }
        });

        resetPasswordButton.addEventListener("click", () => {
          resetPasswordForm.style.display =
            resetPasswordForm.style.display === "none" ? "block" : "none";
        });

        const passwordResetForm = document.getElementById(
          "password-reset-form"
        );
        passwordResetForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const newPassword = document.getElementById("password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          // V√©rification c√¥t√© client
          if (newPassword !== confirmPassword) {
            alert("Les mots de passe ne correspondent pas.");
            return;
          }

          console.log("Donn√©es envoy√©es :", { newPassword }); // Ajoutez ce log

          try {
            const response = await fetch("/api/user/reset-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                newPassword,
              }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Erreur inconnue.");
            }

            alert("Mot de passe r√©initialis√© avec succ√®s !");
            resetPasswordForm.style.display = "none";
          } catch (error) {
            console.error(error);
            alert(
              error.message || "Une erreur est survenue. Veuillez r√©essayer."
            );
          }
        });
      });
    </script>
  </body>
</html>
